<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kubu-Hai Flutter Web ‚Äì AI-Powered PWA</title>

  <!-- Enable TrustedTypes -->
  <meta http-equiv="Content-Security-Policy" content="require-trusted-types-for 'script'">

  <!-- iOS & PWA Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="KubuHai">
  <meta name="theme-color" content="#00d8ff">
  <link rel="manifest" href="manifest.json" />

  <!-- App Icons -->
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-512.png" />

  <!-- Styles -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    body {
      margin: 0;
      background: radial-gradient(circle at 20% 30%, #000000, #0a0a0a, #111);
      color: white;
      font-family: 'Poppins', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    #loader {
      text-align: center;
      animation: fadeIn 2s ease-in-out;
    }
    svg#logo {
      width: 160px;
      height: 160px;
      filter: drop-shadow(0 0 20px #00d8ff);
      animation: pulse 2.5s infinite ease-in-out;
    }
    @keyframes pulse {
      0% { filter: drop-shadow(0 0 20px #00d8ff55); }
      50% { filter: drop-shadow(0 0 45px #00d8ffaa); }
      100% { filter: drop-shadow(0 0 20px #00d8ff55); }
    }
    h1 {
      font-weight: 600;
      font-size: 1.4rem;
      color: #00d8ff;
      margin-top: 25px;
      letter-spacing: 2px;
      text-shadow: 0 0 10px #00d8ff88;
    }
    #offline {
      display: none;
      text-align: center;
      font-size: 1.1rem;
      color: #bbb;
      line-height: 1.6;
      max-width: 90%;
    }
    #offline h1 {
      color: #00d8ff;
      margin-bottom: 10px;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>

  <!-- Injected by Flutter -->
  <script>var serviceWorkerVersion = null;</script>
  <script src="flutter.js" defer></script>
</head>

<body>
  <div id="loader">
    <!-- Glowing AI SVG Logo -->
    <svg id="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <circle cx="50" cy="50" r="45" fill="none" stroke="#00d8ff" stroke-width="3" opacity="0.6"/>
      <circle cx="50" cy="50" r="25" fill="none" stroke="#00d8ff" stroke-width="2" opacity="0.9"/>
      <circle cx="50" cy="50" r="5" fill="#00d8ff"/>
      <path d="M50 5 L65 20 L50 35 L35 20 Z" fill="#00d8ff99">
        <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 50 50" to="360 50 50" dur="10s" repeatCount="indefinite"/>
      </path>
    </svg>

    <h1>Loading Kubu-Hai Web...</h1>
  </div>

  <div id="offline">
    <h1>üöÄ You‚Äôre Offline</h1>
    <p>Kubu-Hai is waiting patiently for your connection.<br>
    Once you‚Äôre back online, it‚Äôll sync everything for you.</p>
  </div>

  <script>
    window.addEventListener('load', function() {
      if (!navigator.onLine) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('offline').style.display = 'block';
        return;
      }

      _flutter.loader.loadEntrypoint({
        onEntrypointLoaded: async function(engineInitializer) {
          const appRunner = await engineInitializer.initializeEngine();
          appRunner.runApp();
        },
        serviceWorker: { serviceWorkerVersion }
      });
    });

    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('‚úÖ Service worker registered:', reg.scope))
          .catch(err => console.warn('‚ö†Ô∏è SW registration failed:', err));
      });
    }
  </script>

  <!-- Inline Manifest -->
  <script type="application/manifest+json">
  {
    "name": "Kubu-Hai Web",
    "short_name": "KubuHai",
    "description": "Empowering Flutter Web with AI, Voice, and PWA Magic ‚ú®",
    "start_url": "./index.html",
    "display": "standalone",
    "orientation": "portrait",
    "background_color": "#0f0f0f",
    "theme_color": "#00d8ff",
    "icons": [
      { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
      { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" },
      { "src": "icon-maskable.png", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
    ]
  }
  </script>

  <!-- Inline Service Worker -->
  <script id="inline-sw" type="text/javascript">
    const CACHE_NAME = "kubu-hai-cache-v1";
    const ASSETS = [
      "./",
      "./index.html",
      "./flutter.js",
      "./icon-192.png",
      "./icon-512.png",
      "./icon-maskable.png"
    ];

    self.addEventListener && self.addEventListener("install", (e) => {
      e.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(ASSETS)));
      self.skipWaiting && self.skipWaiting();
    });

    self.addEventListener && self.addEventListener("activate", (e) => {
      e.waitUntil(
        caches.keys().then((keys) =>
          Promise.all(keys.filter((k) => k !== CACHE_NAME).map((k) => caches.delete(k)))
        )
      );
      self.clients && self.clients.claim();
    });

    self.addEventListener && self.addEventListener("fetch", (e) => {
      e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
    });
  </script>
</body>
</html>
